name: üìù Weekly Code Summary to Slack

on:
  schedule:
    - cron: '0 15 * * FRI'  # Friday 20:00 PKT (15:00 UTC)
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v4
        with: { node-version: '20' }

      - run: npm install

      - name: Run Weekly Script
        id: summary
        env:
          TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_AUTHOR: ${{ secrets.GITHUB_AUTHOR }}
        run: |
          RAW=$(node diary.js)
          POLISHED=$(node diary.js --polished)
          echo "raw<<EOF" >> $GITHUB_OUTPUT && echo "$RAW" >> $GITHUB_OUTPUT && echo "EOF" >> $GITHUB_OUTPUT
          echo "polished<<EOF" >> $GITHUB_OUTPUT && echo "$POLISHED" >> $GITHUB_OUTPUT && echo "EOF" >> $GITHUB_OUTPUT

          # collect blocks
          while read -r line; do
            if [[ "$line" =~ ^block_([0-9]+)<<EOF ]]; then
              idx=${BASH_REMATCH[1]}
              readblock=""
              while read -r inner; do
                [[ "$inner" == "EOF" ]] && break
                readblock+="$inner\n"
              done
              echo "block_${idx}<<EOF" >> $GITHUB_OUTPUT
              echo -e "$readblock" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          done < <(node diary.js --polished)
          TOTAL=$(node diary.js | grep "^TOTAL_BLOCKS=" | cut -d= -f2)
          echo "total_blocks=$TOTAL" >> $GITHUB_OUTPUT

      - name: Send to Slack
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ secrets.SLACK_CHANNEL_ID }}",
              "text": "üì£ Weekly Code Summary",
              "blocks": [
                { "type": "section", "text": {"type": "mrkdwn","text": "*Weekly Code Summary*" }},
                { "type": "divider" },
                $(
                  for i in $(seq 0 ${{ steps.summary.outputs.total_blocks }});
                  do echo "{ \"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"${{ steps.summary.outputs['block_'${i}] }}\" } },";
                  done
                ),
                {
                  "type":"section",
                  "text":{"type":"mrkdwn","text":"*Summary (Polished):*\n${{ steps.summary.outputs.polished }}"}
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
