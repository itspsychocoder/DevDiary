name: üìù Weekly Code Summary to Slack

on:
  schedule:
    - cron: '0 15 * * FRI'  # Runs every Friday at 20:00 PKT (15:00 UTC)
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run Weekly Script (Generate Chunks)
        id: summary
        env:
          TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "üì¶ Generating summaries..."
          
          # Save raw summary
          echo "raw<<EOF" >> $GITHUB_OUTPUT
          node diary.js >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Save polished summary to file
          node diary.js --polished > polished.txt

          # Split by chunk separator
          csplit -f chunk_ -b "%02d.txt" polished.txt "/---chunk-separator---/" {*}

          # Store each chunk in GitHub output
          i=0
          for f in chunk_*.txt; do
            content=$(cat "$f")
            echo "chunk_$i<<EOF" >> $GITHUB_OUTPUT
            echo "$content" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            ((i++))
          done

      - name: Send Raw Summary to Slack
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "üßæ *Weekly Code Summary - Raw*\n```salt\n${{ steps.summary.outputs.raw }}```"
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Send Polished Summary Chunks to Slack
        run: |
          i=0
          while true; do
            chunk="${{ steps.summary.outputs['chunk_' }}$i${{ ''] }}"
            if [ -z "$chunk" ]; then
              break
            fi

            echo "Sending chunk $i..."

            jq -n --arg text "*Polished Summary (Part $((i + 1)))*\n$chunk" \
              --arg channel "${{ secrets.SLACK_CHANNEL_ID }}" \
              '{ channel: $channel, text: $text }' > payload.json

            curl -X POST -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H "Content-Type: application/json" \
              --data @payload.json \
              https://slack.com/api/chat.postMessage

            ((i++))
          done
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
