name: üìù Weekly Code Summary to Slack

on:
  schedule:
    - cron: '0 15 * * FRI'  # Runs every Friday at 20:00 PKT (15:00 UTC)
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run Weekly Script (polished)
        id: summary
        env:
          TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "üìä Generating weekly summary..."
          OUTPUT=$(node diary.js --polished)
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Slack
        uses: slackapi/slack-github-action@v2.1.1
        with:
          payload: |
            {
              "channel": "${{ secrets.SLACK_CHANNEL_ID }}",
              "text": "*Weekly Code Summary*\n${{ steps.summary.outputs.summary }}"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
