name: ðŸ“ Weekly Code Summary to Slack

on:
  schedule:
    - cron: "0 15 * * 5"  # Every Friday at 8 PM PKT (15:00 UTC)
  workflow_dispatch:  # Allow manual trigger

jobs:
  diary:
    runs-on: ubuntu-latest

    env:
      TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Generate polished weekly summary
        id: diary
        run: |
          node diary.js --polished > summary.txt

      - name: Split summary into chunks
        run: |
          awk '/^<<CHUNK>>/ {n++; next} {print > ("chunk" n ".txt")}' summary.txt

      - name: Build Slack message payload
        run: |
          chunks=""
          for f in chunk*.txt; do
            text=$(cat "$f" | jq -Rs .)
            chunks="$chunks, {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": $text}}"
          done
          echo "{\"channel\": \"#diary\", \"blocks\": [${chunks#,}]}" > slack-payload.json

      - name: Send to Slack using chat.postMessage
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          payload-file-path: ./slack-payload.json
          token: ${{ secrets.SLACK_BOT_TOKEN }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
