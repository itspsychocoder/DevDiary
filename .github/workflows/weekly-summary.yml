name: 📝 Weekly Code Summary to Slack

on:
  schedule:
    - cron: '0 15 * * FRI'  # Runs every Friday at 20:00 PKT (15:00 UTC)
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run Weekly Script and Chunk Output
        id: summary
        env:
          TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "📦 Generating polished summary..."
          node diary.js --polished > polished.txt

          # Split into chunks using chunk separator
          csplit -f chunk_ -b "%02d.txt" polished.txt "/---chunk-separator---/" {*}

      - name: Send Polished Summary Chunks to Slack
        run: |
          i=0
          for f in chunk_*.txt; do
            content=$(cat "$f")
            echo "Sending chunk $i..."

            jq -n --arg text "*Polished Summary (Part $((i + 1)))*\n$content" \
              --arg channel "${{ secrets.SLACK_CHANNEL_ID }}" \
              '{ channel: $channel, text: $text }' > payload.json

            curl -X POST -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data @payload.json \
              https://slack.com/api/chat.postMessage

            ((i++))
          done
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
