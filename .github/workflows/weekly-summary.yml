name: üìù Weekly Code Summary to Slack

on:
  schedule:
    - cron: '0 15 * * FRI'  # Runs every Friday at 20:00 PKT (15:00 UTC)
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run Weekly Script (polished)
        id: summary
        env:
          TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          RAW=$(node diary.js)
          POLISHED=$(node diary.js --polished)
          echo "raw<<EOF" >> $GITHUB_OUTPUT
          echo "$RAW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "polished<<EOF" >> $GITHUB_OUTPUT
          echo "$POLISHED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Slack
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            text: "Weekly summary available"
            blocks:
              - type: section
                text:
                  type: mrkdwn
                  text: "*Weekly Code Summary*"
              - type: divider
              - type: section
                text:
                  type: mrkdwn
                  text: "*Raw Summary:*\n```salt\n${{ steps.summary.outputs.raw }}```"
              - type: section
                text:
                  type: mrkdwn
                  text: "*Polished Summary:*\n${{ steps.summary.outputs.polished }}"

        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

